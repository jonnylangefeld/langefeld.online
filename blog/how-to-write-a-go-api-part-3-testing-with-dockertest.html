<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/site.webmanifest">
  <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <title>
    
      How to write a Go API Part 3: Testing With Dockertest &middot; Jonny Langefeld
    
  </title>
  
  <link rel="stylesheet" href="/assets/main.css?1.1">
  <link rel="alternate" type="application/rss+xml" title="Jonny Langefeld" href="/feed.xml">
  
    <script>
  // Google Analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50617617-4', 'auto');
  ga('set', 'anonymizeIp', true)
  ga('send', 'pageview');
</script>
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" href="/">Jonny Langefeld</a>
  
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
            <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
            <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a href="/" class="page-link active">Blog</a>
        <a href="/archive" class="page-link ">Archive</a>
        <a href="/about" class="page-link ">About</a>
      </div>
    </nav>
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div id="sidebar">
  <h1 style="font-size: 21px;">Jonny Langefeld</h1>
  <p>Software Engineer</p>
  <p><a href="/about">Who am I?</a></p>
  <p><a href="/assets/about/Resum%C3%A9%20Jonny%20Langefeld.pdf?v=4" target="_blank">Resum√©</a></p>
  <img src="/assets/Jonny-Langefeld.jpg" />

  <!-- Social links -->
  <ul class="social-media-list" style="margin-top: 20px; margin-bottom: 30px;">
    <li>
      <a href="https://github.com/jonnylangefeld" target="_blank"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

    </li>
    <li>
      <a href="https://twitter.com/jonnylangefeld" target="_blank"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

    </li>
    <li>
      <a href="https://www.linkedin.com/in/jonnylangefeld"><span class="icon icon--linked"><svg width="16px" height="16px" viewBox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

    </li>
    <li>
      <a href="https://instagram.com/jonnylangefeld" target="_blank"><span class="icon icon--instagram"><svg aria-hidden="true" data-prefix="fab" data-icon="instagram" class="svg-inline--fa fa-instagram fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16px" style="padding-right: 4px;"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span><span class="username">jonnylangefeld</span></a>

    </li>
  </ul>

  <hr />

  <p style="line-height: 100%">
  <small>All views expressed are my own and not affiliated with current or former employers.</small>
</p>
</div>


        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline"><a href="/blog/how-to-write-a-go-api-part-3-testing-with-dockertest">How to write a Go API Part 3: Testing With Dockertest</a></h1>
    <p class="post-meta">
      <time datetime="2019-03-04T00:00:00+00:00" itemprop="datePublished">
        
        Mar 4, 2019
      </time>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This is part 3 of 3 blog posts on how to write a Go API. Read the <a href="/blog/how-to-write-a-go-api-part-1-webserver-with-iris">first</a> and <a href="/blog/how-to-write-a-go-api-part-2-database-integration">second</a> part first to build upon the repository. If you are only interested in testing your API, make sure to <a href="https://github.com/jonnylangefeld/go-api-base-project/archive/part-2.zip">download the source code of the second part</a>, as we are incrementally building upon it.</p>

<p>This part is all about testing our Go API. The challenge here is to mock the webserver and the database. Iris comes with it‚Äôs own testing package. To test the database, I have found that <a href="https://github.com/ory/dockertest">Dockertest</a> is a pretty good choice, as it is the only possibility to mock the actual setup of the database inside a Docker container. The module spins up a defined Docker container, runs the tests and destroys it again as if nothing happened. So make sure you have <a href="https://youtu.be/JprTjTViaEA">Docker installed</a> and the daemon up and running as you are executing the tests.</p>

<p>Let‚Äôs get started with the code by creating a new file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"package main"</span> <span class="o">&gt;&gt;</span> main_test.go
</code></pre></div></div>

<p>For typical Go tests, this would be the file that contains all the unit tests. These are basically functions starting with the word <code class="language-plaintext highlighter-rouge">Test...</code>. And we will get to them later, but in our case we have some preliminary steps that are needed for all our unit tests later. And that is setting up the database and starting up the Iris application. That‚Äôs what we will do first.<br />
Add the following code into the <code class="language-plaintext highlighter-rouge">main_test.go</code> file:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">db</span> <span class="o">*</span><span class="n">gorm</span><span class="o">.</span><span class="n">DB</span>
<span class="k">var</span> <span class="n">app</span> <span class="o">*</span><span class="n">iris</span><span class="o">.</span><span class="n">Application</span>

<span class="k">func</span> <span class="n">TestMain</span><span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">M</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre></div></div>

<p>The two variables <code class="language-plaintext highlighter-rouge">db</code> and <code class="language-plaintext highlighter-rouge">app</code> are both empty <a href="https://tour.golang.org/moretypes/1">pointers</a> to a <code class="language-plaintext highlighter-rouge">*gorm.DB</code> and a <code class="language-plaintext highlighter-rouge">*iris.Application</code>, which we will fill with life later. The <code class="language-plaintext highlighter-rouge">TestMain(m *testing.M)</code> function is automatically executed by Go before the tests run. So this is where we set up the app and the database. Let‚Äôs start with the database, since the app needs the database, as described in <a href="/blog/how-to-write-a-go-api-part-2-database-integration">part two</a>. In the following, we will successively add little code blocks into the <code class="language-plaintext highlighter-rouge">TestMain()</code> function and I will show the entire code in the end.<br />
First, we need to create a pool in which we can run the Docker container later:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Create a new pool for Docker containers</span>
<span class="n">pool</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">dockertest</span><span class="o">.</span><span class="n">NewPool</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not connect to Docker: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order to run the pool, we need to define an options object with all the parameters for the Docker container we want to run. We basically spin up the same Docker container as in <a href="/blog/how-to-write-a-go-api-part-2-database-integration">part two</a>, but this time with Go code. I also changed the port, just in case you still have the Postgres Docker container running from <a href="/blog/how-to-write-a-go-api-part-2-database-integration">part two</a>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Pull an image, create a container based on it and set all necessary parameters</span>
<span class="n">opts</span> <span class="o">:=</span> <span class="n">dockertest</span><span class="o">.</span><span class="n">RunOptions</span><span class="p">{</span>
    <span class="n">Repository</span><span class="o">:</span>   <span class="s">"mdillon/postgis"</span><span class="p">,</span>
    <span class="n">Tag</span><span class="o">:</span>          <span class="s">"latest"</span><span class="p">,</span>
    <span class="n">Env</span><span class="o">:</span>          <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"POSTGRES_PASSWORD=mysecretpassword"</span><span class="p">},</span>
    <span class="n">ExposedPorts</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"5432"</span><span class="p">},</span>
    <span class="n">PortBindings</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="n">docker</span><span class="o">.</span><span class="n">Port</span><span class="p">][]</span><span class="n">docker</span><span class="o">.</span><span class="n">PortBinding</span><span class="p">{</span>
        <span class="s">"5432"</span><span class="o">:</span> <span class="p">{</span>
            <span class="p">{</span><span class="n">HostIP</span><span class="o">:</span> <span class="s">"0.0.0.0"</span><span class="p">,</span> <span class="n">HostPort</span><span class="o">:</span> <span class="s">"5433"</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c">// Run the Docker container</span>
<span class="n">resource</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">pool</span><span class="o">.</span><span class="n">RunWithOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not start resource: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, we will try and connect to the database just as the actual code in the <code class="language-plaintext highlighter-rouge">main.go</code> file would try and connect to the database. <!--more--> The Docker container is going to take a while to download and spin up. Since we don‚Äôt know how long we need to wait for that, the <code class="language-plaintext highlighter-rouge">github.com/ory/dockertest</code> package has a build-in <code class="language-plaintext highlighter-rouge">Retry()</code> function, that tries to connect to the database in a loop with exponentially growing time intervals in between. Add this code underneath the last:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Exponential retry to connect to database while it is booting</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">pool</span><span class="o">.</span><span class="n">Retry</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="n">databaseConnStr</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"host=localhost port=5433 user=postgres dbname=postgres password=mysecretpassword sslmode=disable"</span><span class="p">)</span>
    <span class="n">db</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">gorm</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"postgres"</span><span class="p">,</span> <span class="n">databaseConnStr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Database not ready yet (it is booting up, wait for a few tries)..."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="c">// Tests if database is reachable</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">DB</span><span class="p">()</span><span class="o">.</span><span class="n">Ping</span><span class="p">()</span>
<span class="p">});</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not connect to Docker: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note how we fill the <code class="language-plaintext highlighter-rouge">db</code> object defined earlier here. So as soon as we successfully leave the <code class="language-plaintext highlighter-rouge">Retry()</code> function, we have our database ready and can now populate it with the test data. To structure code a little better, I usually do that in a separate function (in this same file). So just add the following function and variable for samples right next to the <code class="language-plaintext highlighter-rouge">TestMain()</code> function:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">initTestDatabase</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">db</span><span class="o">.</span><span class="n">AutoMigrate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">model</span><span class="o">.</span><span class="n">Order</span><span class="p">{})</span>

    <span class="n">db</span><span class="o">.</span><span class="n">Save</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sampleOrders</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Save</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sampleOrders</span><span class="p">[</span><span class="m">1</span><span class="p">])</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">sampleOrders</span> <span class="o">=</span> <span class="p">[]</span><span class="n">model</span><span class="o">.</span><span class="n">Order</span><span class="p">{</span>
    <span class="p">{</span>
        <span class="n">ID</span><span class="o">:</span>          <span class="m">1</span><span class="p">,</span>
        <span class="n">Description</span><span class="o">:</span> <span class="s">"An old glove"</span><span class="p">,</span>
        <span class="n">Ts</span><span class="o">:</span>          <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">()</span> <span class="o">*</span> <span class="m">1000</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">ID</span><span class="o">:</span>          <span class="m">2</span><span class="p">,</span>
        <span class="n">Description</span><span class="o">:</span> <span class="s">"Something you don't need"</span><span class="p">,</span>
        <span class="n">Ts</span><span class="o">:</span>          <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span><span class="p">()</span> <span class="o">*</span> <span class="m">1000</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Back inside the <code class="language-plaintext highlighter-rouge">TestMain()</code> function, we can then call the <code class="language-plaintext highlighter-rouge">initTestDatabase()</code> function, as well as create the mock Iris app for the tests:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Initialize test database..."</span><span class="p">)</span>
<span class="n">initTestDatabase</span><span class="p">()</span>

<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Create new Iris app..."</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">newApp</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, right after we have the <code class="language-plaintext highlighter-rouge">app</code> and the <code class="language-plaintext highlighter-rouge">db</code> ready, we can finally run our actual test cases, which we will define later. At this point we will just call</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Run the actual test cases (functions that start with Test...)</span>
<span class="n">code</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
</code></pre></div></div>

<p>Once the test cases have run, we will just remove the Docker container and exit the program:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Delete the Docker container</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">pool</span><span class="o">.</span><span class="n">Purge</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not purge resource: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</code></pre></div></div>

<p>At this point we can now add our actual test cases (functions that start with <code class="language-plaintext highlighter-rouge">Test...</code>). To compare the actual result with an expected result, we use the package <a href="https://github.com/stretchr/testify"><code class="language-plaintext highlighter-rouge">github.com/stretchr/testify</code></a>. I have annotated the following code to understand what we are doing:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestName</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// Request an endpoint of the app</span>
    <span class="n">e</span> <span class="o">:=</span> <span class="n">httptest</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">httptest</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="s">"http://localhost"</span><span class="p">))</span>
    <span class="n">t1</span> <span class="o">:=</span> <span class="n">e</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="s">"/Bill"</span><span class="p">)</span><span class="o">.</span><span class="n">Expect</span><span class="p">()</span><span class="o">.</span><span class="n">Status</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">)</span>

    <span class="c">// Compare the actual result with an expected result</span>
    <span class="n">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">"Hello Bill"</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">Body</span><span class="p">()</span><span class="o">.</span><span class="n">Raw</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestOrders</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span> <span class="o">:=</span> <span class="n">httptest</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">httptest</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="s">"http://localhost"</span><span class="p">))</span>
    <span class="n">t1</span> <span class="o">:=</span> <span class="n">e</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span><span class="o">.</span><span class="n">Expect</span><span class="p">()</span><span class="o">.</span><span class="n">Status</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">)</span>
    
    <span class="n">expected</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">sampleOrders</span><span class="p">)</span>
    <span class="n">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">t1</span><span class="o">.</span><span class="n">Body</span><span class="p">()</span><span class="o">.</span><span class="n">Raw</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, I don‚Äôt assume that any of you have kept track of all the necessary imports we  need for all the code above. So here is the import block that we need in the beginning of the <code class="language-plaintext highlighter-rouge">test_main.go</code> file:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
    <span class="s">"encoding/json"</span>
    <span class="s">"fmt"</span>
    <span class="s">"log"</span>
    <span class="s">"my-go-api/model"</span>
    <span class="s">"os"</span>
    <span class="s">"testing"</span>
    <span class="s">"time"</span>

    <span class="s">"github.com/jinzhu/gorm"</span>
    <span class="s">"github.com/kataras/iris/v12"</span>
    <span class="s">"github.com/kataras/iris/v12/httptest"</span>
    <span class="s">"github.com/ory/dockertest"</span>
    <span class="s">"github.com/ory/dockertest/docker"</span>
    <span class="s">"github.com/stretchr/testify/assert"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>And that‚Äôs it üéâ! We can now run the tests with</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go <span class="nb">test</span> <span class="nt">-v</span>
</code></pre></div></div>

<p>And we will get the following output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2019/02/17 08:15:06 Database not ready yet (it is booting up, wait for a few tries)...
2019/02/17 08:15:12 Initialize test database...
2019/02/17 08:15:12 Create new Iris app...
=== RUN   TestName
--- PASS: TestName (0.00s)
=== RUN   TestOrders
--- PASS: TestOrders (0.00s)
PASS
ok      my-go-api       17.111s
</code></pre></div></div>

<p>Yay! The tests are successful üëçüèº<br />
If you missed something, <a href="https://github.com/jonnylangefeld/go-api-base-project/blob/part-3/main_test.go">click here</a> to see the code of the entire <code class="language-plaintext highlighter-rouge">test_main.go</code> file, or just <a href="https://github.com/jonnylangefeld/go-api-base-project/archive/part-3.zip">download the entire source code of the project</a>.</p>

  </div>

  <p class="extra-info">
    
      Tags: go, golang, api, programming, software development, repo, go base project, dockertest
    
  </p>
</article>

      </div>
    </main>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          <li>
            <a href="https://github.com/jonnylangefeld" target="_blank"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

          </li>
          <li>
            <a href="https://twitter.com/jonnylangefeld" target="_blank"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

          </li>
          <li>
            <a href="https://www.linkedin.com/in/jonnylangefeld"><span class="icon icon--linked"><svg width="16px" height="16px" viewBox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

          </li>
          <li>
            <a href="https://instagram.com/jonnylangefeld" target="_blank"><span class="icon icon--instagram"><svg aria-hidden="true" data-prefix="fab" data-icon="instagram" class="svg-inline--fa fa-instagram fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16px" style="padding-right: 4px;"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span><span class="username">jonnylangefeld</span></a>

          </li>
        </ul>
      </div>
      <div class="footer-col footer-col-2"></div>

      <div class="footer-col footer-col-3" style="text-align: right">
        <p>email: <a href="mailto:jonny.langefeld@gmail.com">jonny.langefeld@gmail.com</a><br />
          twitter: <a href="https://twitter.com/jonnylangefeld" target="_blank">@jonnylangefeld</a></p>
      </div>
    </div>

  </div>
</footer>

<script type="text/javascript">
  var links = document.links;
  for (var i = 0, linksLength = links.length; i < linksLength; i++) {
    if (links[i].hostname != window.location.hostname) {
      links[i].target = '_blank';
    } 
  }
</script>


  </body>

</html>
