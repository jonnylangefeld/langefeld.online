<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/site.webmanifest">
  <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <title>
    
      How to write a Go API: The Ultimate Guide &middot; Jonny Langefeld
    
  </title>
  
  <link rel="stylesheet" href="/assets/main.css?1.1">
  <link rel="alternate" type="application/rss+xml" title="Jonny Langefeld" href="/feed.xml">
  
    <script>
  // Google Analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50617617-4', 'auto');
  ga('set', 'anonymizeIp', true)
  ga('send', 'pageview');
</script>
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    <a class="site-title" href="/">Jonny Langefeld</a>
  
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
            <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
            <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a href="/" class="page-link active">Blog</a>
        <a href="/archive" class="page-link ">Archive</a>
        <a href="/about" class="page-link ">About</a>
      </div>
    </nav>
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div id="sidebar">
  <h1 style="font-size: 21px;">Jonny Langefeld</h1>
  <p>Software Engineer</p>
  <p><a href="/about">Who am I?</a></p>
  <p><a href="/assets/about/Resum%C3%A9%20Jonny%20Langefeld.pdf?v=4" target="_blank">Resumé</a></p>
  <img src="/assets/Jonny-Langefeld.jpg" />

  <!-- Social links -->
  <ul class="social-media-list" style="margin-top: 20px; margin-bottom: 30px;">
    <li>
      <a href="https://github.com/jonnylangefeld" target="_blank"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

    </li>
    <li>
      <a href="https://twitter.com/jonnylangefeld" target="_blank"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

    </li>
    <li>
      <a href="https://www.linkedin.com/in/jonnylangefeld"><span class="icon icon--linked"><svg width="16px" height="16px" viewBox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

    </li>
    <li>
      <a href="https://instagram.com/jonnylangefeld" target="_blank"><span class="icon icon--instagram"><svg aria-hidden="true" data-prefix="fab" data-icon="instagram" class="svg-inline--fa fa-instagram fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16px" style="padding-right: 4px;"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span><span class="username">jonnylangefeld</span></a>

    </li>
  </ul>

  <hr />

  <p style="line-height: 100%">
  <small>All views expressed are my own and not affiliated with current or former employers.</small>
</p>
</div>


        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline"><a href="/blog/how-to-write-a-go-api-the-ultimate-guide">How to write a Go API: The Ultimate Guide</a></h1>
    <p class="post-meta">
      <time datetime="2020-10-28T00:00:00+00:00" itemprop="datePublished">
        
        Oct 28, 2020
      </time>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><img src="/assets/posts/gopher.svg" width="35%" align="right" style="margin: 15px" /></p>

<p>“TIL” (<a href="https://www.urbandictionary.com/define.php?term=TIL">today I learned</a>) is an acronym I recently discovered (Example usage: “TIL what TIL means”). Since I’m ESL (<a href="https://www.urbandictionary.com/define.php?term=ESL">English as Second Language</a>) I use the urban dictionary a lot to look up these acronyms. “TIL” turned out to be a very useful term, because it’s true: One never stops learning. And so it happened that I started this blog writing about <a href="/blog/python-flask-base-project">a Python Flask API</a> and continued with a three part series on <a href="/blog/how-to-write-a-go-api-part-1-webserver-with-iris">how to write a go API</a>. And while there is a lot of valuable information in those posts, today I am writing about what I learned since then and what my current set of best practices is to write an efficient and production ready API.</p>

<p>Reading many blogs myself, I sometimes miss context on given examples. So I published a sample repo which can be found on <a href="https://jonnylangefeld/go-api">github</a>. Every code example in this post links to the source lines of this repo.</p>

<p>The following paragraphs feature a large set of best practices and why I like them. Send me an <a href="/about#contactform">email</a> or tweet me <a href="https://twitter.com/jonnylangefeld">@jonnylangefeld</a> if you feel like something is missing!</p>

<!--more-->

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#1-project-scaffolding">1. Project Scaffolding</a></li>
  <li><a href="#2-the-toolsgo-pattern">2. The tools.go Pattern</a></li>
  <li><a href="#3-command-line-flags-with-pflag">3. Command Line Flags With pflag</a></li>
  <li><a href="#4-structured-logging-with-zap">4. Structured Logging With zap</a></li>
  <li><a href="#5-graceful-exits">5. Graceful Exits</a></li>
  <li><a href="#6-log-version-on-startup">6. Log Version on Startup</a></li>
  <li><a href="#7-define-types-in-their-own-package">7. Define Types in Their Own Package</a></li>
  <li><a href="#8-chi-as-http-framework">8. chi as HTTP Framework</a></li>
  <li><a href="#9-custom-middlewares">9. Custom Middlewares</a></li>
  <li><a href="#10-pagination">10. Pagination</a></li>
  <li><a href="#11-database-integration-with-gorm">11. Database Integration With gorm</a></li>
  <li><a href="#12-database-integration-tests-with-dockertest">12. Database Integration Tests With dockertest</a></li>
  <li><a href="#13-api-integration-tests-with-gomock">13. API Integration Tests With gomock</a></li>
  <li><a href="#14-render-responses-with-go-chirender">14. Render Responses With go-chi/render</a></li>
  <li><a href="#15-documentation-as-code-with-http-swagger">15. Documentation as Code With http-swagger</a></li>
  <li><a href="#16-staged-dockerfile">16. Staged Dockerfile</a></li>
</ul>

<h3 id="1-project-scaffolding">1. Project Scaffolding</h3>

<p>I use the following tree as project layout. More packages can be added under <code class="language-plaintext highlighter-rouge">pkg</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── Dockerfile
├── Makefile
├── docs                    # automatically generated by `make docs`
├── go.mod
├── go.sum
├── main.go                 # main.go in the root rather than in `/cmd` directory
├── pkg
│   ├── api                 # containing all API related functions and the router
│   │   ├── api.go
│   │   ├── api_test.go
│   │   └── operations.go
│   ├── db                  # all database interactions happen in here
│   │   ├── db.go
│   │   └── db_test.go
│   ├── middelware          # for custom middlewares
│   │   ├── context.go
│   │   └── logger.go
│   └── types               # our types get a separate package
│       └── types.go
├── readme.md
└── tools.go                # tools.go to manage tool versions via go.mod
</code></pre></div></div>

<p>With that out of the way, lets look into the <code class="language-plaintext highlighter-rouge">main.go</code> file.</p>

<h3 id="2-the-toolsgo-pattern">2. The tools.go Pattern</h3>

<p>I’m really a fan of managing tool dependencies also through go modules. That pins their versions and includes them in my vendor directory. Marco Franssen wrote in-depth about this pattern in <a href="https://marcofranssen.nl/manage-go-tools-via-go-modules/">this blog post</a>.</p>

<h3 id="3-command-line-flags-with-pflag">3. Command Line Flags With <a href="https://github.com/spf13/pflag">pflag</a></h3>

<p>There are many ways to work with command line flags and configurations in go. One can go fancy with <a href="https://github.com/spf13/viper"><code class="language-plaintext highlighter-rouge">viper</code></a> or stay simple with go’s built in <code class="language-plaintext highlighter-rouge">flags</code> package. I like <a href="https://github.com/spf13/pflag"><code class="language-plaintext highlighter-rouge">pflag</code></a> because of it’s simplicity and similarity to go’s own package, yet it offers POSIX/GNU-style flags making it more natural to use on your command line. The <a href="https://jonnylangefeld/go-api">sample repo</a> contains an example usage:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">pflag</span><span class="o">.</span><span class="n">StringVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="s">"address"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">,</span> <span class="s">":8080"</span><span class="p">,</span> <span class="s">"the address for the api to listen on. Host and port separated by ':'"</span><span class="p">)</span>
	<span class="n">pflag</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/main.go#L22-L25">source</a></em>)</sup></p>

<p>Pflag comes with help built in:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ go-api -h
Usage of go-api:
  -a, --address string   the address for the api to listen on. Host and port separated by ':' (default ":8080")

</code></pre></div></div>

<h3 id="4-structured-logging-with-zap">4. Structured Logging With <a href="https://github.com/uber-go/zap">zap</a></h3>

<p>This is certainly an opinionated decision, but my favorite logger is <a href="https://github.com/uber-go/zap">zap</a>. It can be configured in all kinds of ways, but I like to keep it very simple. This is the configuration I use:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// configure logger</span>
<span class="n">log</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">zap</span><span class="o">.</span><span class="n">NewProduction</span><span class="p">(</span><span class="n">zap</span><span class="o">.</span><span class="n">WithCaller</span><span class="p">(</span><span class="no">false</span><span class="p">))</span>
<span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">Sync</span><span class="p">()</span>
<span class="p">}()</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/main.go#L34-L38">source</a></em>)</sup></p>

<p>Which gives me a beautiful log output like the following:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"level"</span><span class="p">:</span><span class="s2">"info"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mf">1601686510.597971</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"starting up API..."</span><span class="p">,</span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"v1.0.0"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"level"</span><span class="p">:</span><span class="s2">"info"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mf">1601686510.70517</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"ready to serve requests on :8080"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"level"</span><span class="p">:</span><span class="s2">"info"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mf">1601686516.446462</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"served request"</span><span class="p">,</span><span class="nl">"proto"</span><span class="p">:</span><span class="s2">"HTTP/1.1"</span><span class="p">,</span><span class="nl">"method"</span><span class="p">:</span><span class="s2">"GET"</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/articles"</span><span class="p">,</span><span class="nl">"lat"</span><span class="p">:</span><span class="mf">0.002087763</span><span class="p">,</span><span class="nl">"status"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="nl">"size"</span><span class="p">:</span><span class="mi">13</span><span class="p">,</span><span class="nl">"reqId"</span><span class="p">:</span><span class="s2">"C02C864PLVDL/gESGYmlmCu-000001"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"level"</span><span class="p">:</span><span class="s2">"info"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mf">1601686521.3242629</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"served request"</span><span class="p">,</span><span class="nl">"proto"</span><span class="p">:</span><span class="s2">"HTTP/1.1"</span><span class="p">,</span><span class="nl">"method"</span><span class="p">:</span><span class="s2">"GET"</span><span class="p">,</span><span class="nl">"path"</span><span class="p">:</span><span class="s2">"/orders"</span><span class="p">,</span><span class="nl">"lat"</span><span class="p">:</span><span class="mf">0.002300746</span><span class="p">,</span><span class="nl">"status"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="nl">"size"</span><span class="p">:</span><span class="mi">13</span><span class="p">,</span><span class="nl">"reqId"</span><span class="p">:</span><span class="s2">"C02C864PLVDL/gESGYmlmCu-000002"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"level"</span><span class="p">:</span><span class="s2">"info"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mf">1601686525.5588071</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"gracefully shutting down"</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<h3 id="5-graceful-exits">5. Graceful Exits</h3>

<p>This one is not ultimately necessary but I’ve seen it a lot and ensures cleanup tasks when the API is shutting down. A graceful exit is implemented by making a channel in the beginning of your program and listening for a certain event, like this one for a keyboard interrupt:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// gracefully exit on keyboard interrupt</span>
<span class="n">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">os</span><span class="o">.</span><span class="n">Signal</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
<span class="n">signal</span><span class="o">.</span><span class="n">Notify</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/main.go#L30-L32">source</a></em>)</sup></p>

<p>At the end of the program, after starting the webserver in a go routine (see #5), we react to the signal:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;-</span><span class="n">c</span>
<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"gracefully shutting down"</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/main.go#L58-L61">source</a></em>)</sup></p>

<h3 id="6-log-version-on-startup">6. Log Version on Startup</h3>

<p>This one is also minor, but it turns out to be very useful to see the version by just reading the logs for debugging. It makes it clear which exact code base ran the code and resulted in a potential error.</p>

<p>The version is injected by using an unset <code class="language-plaintext highlighter-rouge">version</code> variable in the <code class="language-plaintext highlighter-rouge">main.go</code> file and setting it via the build command (for instance in your <code class="language-plaintext highlighter-rouge">Makefile</code>):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VERSION ?<span class="o">=</span> <span class="si">$(</span>shell git describe <span class="nt">--match</span> <span class="s1">'v[0-9]*'</span> <span class="nt">--tags</span> <span class="nt">--always</span><span class="si">)</span>

build:
	@go build <span class="nt">-ldflags</span> <span class="s2">"-X main.version=</span><span class="si">$(</span>VERSION<span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/Makefile#L1-L4">source</a></em>)</sup></p>

<p>In the <code class="language-plaintext highlighter-rouge">main.go</code> file you can use the version as follows (after instantiating it via <code class="language-plaintext highlighter-rouge">var version string</code>):</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// print current version</span>
<span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"starting up API..."</span><span class="p">,</span> <span class="n">zap</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"version"</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/main.go#L40-L41">source</a></em>)</sup></p>

<h3 id="7-define-types-in-their-own-package">7. Define Types in Their Own Package</h3>

<p>Types should be reusable. Let’s say someone was to build a command line interface interacting with your API, they would appreciate if they could just import your API types. So we define types as <code class="language-plaintext highlighter-rouge">struct</code>s in <code class="language-plaintext highlighter-rouge">pkg/types/types.go</code> (we will get to the struct tags and the doc strings later):</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Article is one instance of an article</span>
<span class="k">type</span> <span class="n">Article</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// The unique id of this item</span>
	<span class="n">ID</span> <span class="kt">int</span> <span class="s">`gorm:"type:SERIAL;PRIMARY_KEY" json:"id" example:"1"`</span>
	<span class="c">// The name of this item</span>
	<span class="n">Name</span> <span class="kt">string</span> <span class="s">`gorm:"type:varchar;NOT NULL" json:"name" example:"Skittles"`</span>
	<span class="c">// The price of this item</span>
	<span class="n">Price</span> <span class="kt">float64</span> <span class="s">`gorm:"type:decimal;NOT NULL" json:"price" example:"1.99"`</span>
<span class="p">}</span> <span class="c">// @name Article</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/types/types.go#L10-L18">source</a></em>)</sup></p>

<h3 id="8-chi-as-http-framework">8. <a href="https://github.com/go-chi/chi">chi</a> as HTTP Framework</h3>

<p>My http framework of choice these days is <a href="https://github.com/go-chi/chi">go-chi/chi</a> (upon recommendation by <a href="https://twitter.com/elsesiy">@elsesiy</a> - thank you!) for its light weight, idiomatic implementation, but mainly for its 100% compatibility with <code class="language-plaintext highlighter-rouge">net/http</code> allowing you to use any existing middleware.</p>

<p>The server is started as go routine and listens on the configured address:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// start the api server</span>
<span class="n">r</span> <span class="o">:=</span> <span class="n">api</span><span class="o">.</span><span class="n">GetRouter</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">dbClient</span><span class="p">)</span>
<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"failed to start server"</span><span class="p">,</span> <span class="n">zap</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}()</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/main.go#L49-L56">source</a></em>)</sup></p>

<p>The router gets configured in the <code class="language-plaintext highlighter-rouge">api</code> package, setting the db client and the logger:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">GetRouter</span><span class="p">(</span><span class="n">log</span> <span class="o">*</span><span class="n">zap</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span> <span class="n">dbClient</span> <span class="n">db</span><span class="o">.</span><span class="n">ClientInterface</span><span class="p">)</span> <span class="o">*</span><span class="n">chi</span><span class="o">.</span><span class="n">Mux</span> <span class="p">{</span>
	<span class="n">r</span> <span class="o">:=</span> <span class="n">chi</span><span class="o">.</span><span class="n">NewRouter</span><span class="p">()</span>
	<span class="n">r</span><span class="o">.</span><span class="n">Use</span><span class="p">(</span><span class="n">middleware</span><span class="o">.</span><span class="n">RequestID</span><span class="p">)</span>
	<span class="n">SetDBClient</span><span class="p">(</span><span class="n">dbClient</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">log</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">.</span><span class="n">Use</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">SetLogger</span><span class="p">(</span><span class="n">log</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="n">buildTree</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">r</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api.go#L31-L41">source</a></em>)</sup></p>

<p>The tree of requests looks in code just as it would like in a folder structure. Every sub request is attached to its parent. Here is an example request tree, that handles articles and orders for a store:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">buildTree</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">chi</span><span class="o">.</span><span class="n">Mux</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">r</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/swagger"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">http</span><span class="o">.</span><span class="n">Redirect</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">RequestURI</span><span class="o">+</span><span class="s">"/"</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusMovedPermanently</span><span class="p">)</span>
	<span class="p">})</span>
	<span class="n">r</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"/swagger*"</span><span class="p">,</span> <span class="n">httpSwagger</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>

	<span class="n">r</span><span class="o">.</span><span class="n">Route</span><span class="p">(</span><span class="s">"/articles"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="n">chi</span><span class="o">.</span><span class="n">Router</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Pagination</span><span class="p">)</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">ListArticles</span><span class="p">)</span>

		<span class="n">r</span><span class="o">.</span><span class="n">Route</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="n">chi</span><span class="o">.</span><span class="n">Router</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">.</span><span class="n">Use</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Article</span><span class="p">)</span>
			<span class="n">r</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">GetArticle</span><span class="p">)</span>
		<span class="p">})</span>

		<span class="n">r</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">PutArticle</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="n">r</span><span class="o">.</span><span class="n">Route</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="n">chi</span><span class="o">.</span><span class="n">Router</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Pagination</span><span class="p">)</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">ListOrders</span><span class="p">)</span>

		<span class="n">r</span><span class="o">.</span><span class="n">Route</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="n">chi</span><span class="o">.</span><span class="n">Router</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">.</span><span class="n">Use</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Order</span><span class="p">)</span>
			<span class="n">r</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">GetOrder</span><span class="p">)</span>
		<span class="p">})</span>

		<span class="n">r</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">PutOrder</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api.go#L43-L70">source</a></em>)</sup></p>

<h3 id="9-custom-middlewares">9. Custom Middlewares</h3>

<p>In the tree above, you can spot the usage of</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="n">r</span><span class="o">.</span><span class="n">Route</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="n">chi</span><span class="o">.</span><span class="n">Router</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">.</span><span class="n">Use</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Article</span><span class="p">)</span>
			<span class="n">r</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">GetArticle</span><span class="p">)</span>
		<span class="p">})</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api.go#L52-L55">source</a></em>)</sup></p>

<p>Custom middlewares live in the <code class="language-plaintext highlighter-rouge">middleware</code> package. <code class="language-plaintext highlighter-rouge">m</code> is our custom middleware, imported through</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">m</span> <span class="s">"github.com/jonnylangefeld/go-api/pkg/middelware"</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api.go#L13">source</a></em>)</sup></p>

<p>Custom middlewares are very powerful. They are basically an injection into the sequence of handlers of the api and can do anything ‘along the way’. In this instance we know we are in a part of our router tree, that will always require the article object pulled from the database. So we inject a custom middleware, that does exactly that for us and injects it into the context of the request. The context is available through the entire handler chain, so for any succeeding handler our object will be available.</p>

<p>The following middelware is the <code class="language-plaintext highlighter-rouge">http.Handler</code> we used above via <code class="language-plaintext highlighter-rouge">r.Use(m.Article)</code> and injects the article object into the context.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Article middleware is used to load an Article object from</span>
<span class="c">// the URL parameters passed through as the request. In case</span>
<span class="c">// the Article could not be found, we stop here and return a 404.</span>
<span class="k">func</span> <span class="n">Article</span><span class="p">(</span><span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">var</span> <span class="n">article</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span>

		<span class="k">if</span> <span class="n">id</span> <span class="o">:=</span> <span class="n">chi</span><span class="o">.</span><span class="n">URLParam</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">"id"</span><span class="p">);</span> <span class="n">id</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
			<span class="n">intID</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="n">_</span> <span class="o">=</span> <span class="n">render</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ErrInvalidRequest</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="n">article</span> <span class="o">=</span> <span class="n">DBClient</span><span class="o">.</span><span class="n">GetArticleByID</span><span class="p">(</span><span class="n">intID</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">_</span> <span class="o">=</span> <span class="n">render</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ErrNotFound</span><span class="p">())</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">article</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">_</span> <span class="o">=</span> <span class="n">render</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ErrNotFound</span><span class="p">())</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="n">ctx</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithValue</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Context</span><span class="p">(),</span> <span class="n">ArticleCtxKey</span><span class="p">,</span> <span class="n">article</span><span class="p">)</span>
		<span class="n">next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">WithContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/middelware/context.go#L33-L59">source</a></em>)</sup></p>

<p>Later on in our handlers, we just pull the article from the context, without reaching out to the database again.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">GetArticle</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">article</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ArticleCtxKey</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">render</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">article</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">_</span> <span class="o">=</span> <span class="n">render</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ErrRender</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/operations.go#L22-L29">source</a></em>)</sup></p>

<p>The article object is available for every child in the request tree, which makes these custom middlewares so powerful.</p>

<h3 id="10-pagination">10. Pagination</h3>

<p>Click <a href="/blog/how-to-write-a-go-api-pagination">here</a> to read the separate blog post on pagination.</p>

<h3 id="11-database-integration-with-gorm">11. Database Integration With <a href="https://github.com/go-gorm/gorm">gorm</a></h3>

<p>In <a href="/blog/how-to-write-a-go-api-part-2-database-integration">previous blog posts</a> I have described how I use <a href="https://github.com/go-gorm/gorm">gorm</a> as an object relational mapping framework in go APIs. That has not changed so far. I like the ease of use and the ability to still write raw SQL if I need to. That especially comes in handy if the underlying database is <a href="https://www.postgresql.org/">postgres</a>, which has a bunch of custom features that no ORM would naturally cover. Go check out my <a href="/blog/how-to-write-a-go-api-part-2-database-integration">old blog post</a> for in-depth coverage.</p>

<p>However, I did change how I interact with the database client. Rather than just using the bare-bone <code class="language-plaintext highlighter-rouge">gorm.Open()</code> call in the <code class="language-plaintext highlighter-rouge">main()</code> function, I do write a custom client interface, that wraps the gorm client. The custom client interface features a <code class="language-plaintext highlighter-rouge">Connect()</code> function to establish the database and a bunch of functions that will be called by the different API endpoints. This interfacing will help us later to write API integration tests with <a href="#13-api-integration-tests-with-gomock">integration tests with gomock</a>.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// ClientInterface resembles a db interface to interact with an underlying db</span>
<span class="k">type</span> <span class="n">ClientInterface</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">Ping</span><span class="p">()</span> <span class="kt">error</span>
	<span class="n">Connect</span><span class="p">(</span><span class="n">connectionString</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
	<span class="n">GetArticleByID</span><span class="p">(</span><span class="n">id</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span>
	<span class="n">SetArticle</span><span class="p">(</span><span class="n">article</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span><span class="p">)</span> <span class="kt">error</span>
	<span class="n">GetArticles</span><span class="p">(</span><span class="n">pageID</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">ArticleList</span>
	<span class="n">GetOrderByID</span><span class="p">(</span><span class="n">id</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Order</span>
	<span class="n">SetOrder</span><span class="p">(</span><span class="n">order</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Order</span><span class="p">)</span> <span class="kt">error</span>
	<span class="n">GetOrders</span><span class="p">(</span><span class="n">pageID</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">OrderList</span>
<span class="p">}</span>

<span class="c">// Client is a custom db client</span>
<span class="k">type</span> <span class="n">Client</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Client</span> <span class="o">*</span><span class="n">gorm</span><span class="o">.</span><span class="n">DB</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/db/db.go#L17-L32">source</a></em>)</sup></p>

<p>This pattern allows us to still access the underlying client if we ever needed to. Now this does create a funny looking construct that looks like <code class="language-plaintext highlighter-rouge">client.Client</code>, but I’ve seen this pattern <a href="https://github.com/kubernetes-sigs/controller-runtime/blob/master/pkg/client/client.go#L95">elsewhere</a> and actually think it is quite useful, to still make lower level function calls available to higher level interfaces.</p>

<h3 id="12-database-integration-tests-with-dockertest">12. Database Integration Tests With <a href="https://github.com/ory/dockertest">dockertest</a></h3>

<p>Database integration tests are important to be done on a database as close as possible to the one intended to be used in production. That is because databases have many different flavors and they all have their own quirks. Especially for a database like postgres this is important, as postgres offers a lot of custom functions and features, that can’t be replicated through other testing methods like dependency injection.</p>

<p>The best way to create a short-lived database, that’s just there during testing and always has the same state, is through a docker container. That can be easily run locally and on CI systems and ensures that we interact correctly with the actual database.</p>

<p>Just as the last topic, I have describe this concept in a <a href="/blog/how-to-write-a-go-api-part-3-testing-with-dockertest">blog post last year</a> and this has probably changed the least since I’ve blogged about it, so the old post is still accurate. To see how it integrates into the sample repository, check the <a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/db/db_test.go"><code class="language-plaintext highlighter-rouge">pkg/db/db_test.go</code> file</a>.</p>

<h3 id="13-api-integration-tests-with-gomock">13. API Integration Tests With <a href="https://github.com/golang/mock">gomock</a></h3>

<p><a href="https://github.com/golang/mock">gomock</a> is a great tool for any kind of integration tests. The basic idea is to mock an interface of another package, so you don’t have to set up a dependency just for testing. Imagine a tool that pulls in data from the Google Calendar API, you don’t want to be dependent on the Google Calendar API up and running during your integration tests. So you mock the dependency. The assumption here is that the used dependency is itself tested properly. The way this is done is through an interface, for which we can replace functions during our tests.</p>

<p>In the scenario of our <a href="https://github.com/jonnylangefeld/go-api">demo go-api</a>, our API operations depend on the database. That would mean that we need an up and running database for API integration tests. However, we covered proper <a href="#12-database-integration-tests-with-dockertest">database integration tests earlier</a>, so now we can assume those database calls are working properly. And to not also depend on the up and running database during API integration tests, we mock the database calls as follows:</p>

<p>First off, <a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/tools.go#L6">add gomock to the <code class="language-plaintext highlighter-rouge">tools.go</code> file</a>. Then we’ll add this section to the api integration tests:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//go:generate $GOPATH/bin/mockgen -destination=./mocks/db.go -package=mocks github.com/jonnylangefeld/go-api/pkg/db ClientInterface</span>

<span class="k">func</span> <span class="n">getDBClientMock</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span><span class="n">mocks</span><span class="o">.</span><span class="n">MockClientInterface</span> <span class="p">{</span>
	<span class="n">ctrl</span> <span class="o">:=</span> <span class="n">gomock</span><span class="o">.</span><span class="n">NewController</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
	<span class="n">dbClient</span> <span class="o">:=</span> <span class="n">mocks</span><span class="o">.</span><span class="n">NewMockClientInterface</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>

	<span class="n">dbClient</span><span class="o">.</span><span class="n">EXPECT</span><span class="p">()</span><span class="o">.</span><span class="n">GetArticles</span><span class="p">(</span><span class="n">gomock</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="o">.</span><span class="n">ArticleList</span><span class="p">{</span>
		<span class="n">Items</span><span class="o">:</span> <span class="p">[]</span><span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span><span class="p">{</span>
			<span class="o">&amp;</span><span class="n">testArticle1</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">testArticle2</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">})</span>

	<span class="n">dbClient</span><span class="o">.</span><span class="n">EXPECT</span><span class="p">()</span><span class="o">.</span><span class="n">GetArticles</span><span class="p">(</span><span class="n">gomock</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">types</span><span class="o">.</span><span class="n">ArticleList</span><span class="p">{</span>
		<span class="n">Items</span><span class="o">:</span> <span class="p">[]</span><span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span><span class="p">{</span>
			<span class="o">&amp;</span><span class="n">testArticle2</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">})</span>

	<span class="n">dbClient</span><span class="o">.</span><span class="n">EXPECT</span><span class="p">()</span><span class="o">.</span><span class="n">GetArticleByID</span><span class="p">(</span><span class="n">gomock</span><span class="o">.</span><span class="n">Eq</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">testArticle1</span><span class="p">)</span><span class="o">.</span><span class="n">AnyTimes</span><span class="p">()</span>

	<span class="n">dbClient</span><span class="o">.</span><span class="n">EXPECT</span><span class="p">()</span><span class="o">.</span><span class="n">SetArticle</span><span class="p">(</span><span class="n">gomock</span><span class="o">.</span><span class="n">Any</span><span class="p">())</span><span class="o">.</span><span class="n">DoAndReturn</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">article</span> <span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">ID</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
			<span class="n">article</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="m">1</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="no">nil</span>
	<span class="p">})</span><span class="o">.</span><span class="n">AnyTimes</span><span class="p">()</span>

	<span class="k">return</span> <span class="n">dbClient</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api_test.go#L74-L103">source</a></em>)</sup></p>

<p>The first line of this section is important, even though commented out. It tells <code class="language-plaintext highlighter-rouge">go generate</code> (which we will call through a <a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/Makefile#L26-L27">Makefile target</a>) that here is an execution to be done. It means that <code class="language-plaintext highlighter-rouge">mockgen</code> should mock the <code class="language-plaintext highlighter-rouge">ClientInterface</code> in the <code class="language-plaintext highlighter-rouge">github.com/jonnylangefeld/go-api/pkg/db</code> package. It does that by creating a new file (<code class="language-plaintext highlighter-rouge">./mocks/db.go</code> in this case) with a whole bunch of generated code that is not meant to be touched. But we can now use the mock interface in the form of <code class="language-plaintext highlighter-rouge">mocks.NewMockClientInterface(ctrl)</code>. All functions of the mocked interface are available in this mock and can now be overwritten with custom logic. In the example above we are responding with different returns for different IDs of the <code class="language-plaintext highlighter-rouge">GetArticles()</code> function and mock some other functions of the interface as well.</p>

<p>Now once we run the actual API integration tests, we don’t initialize the API router with an interface to the actual database, but with the just created mock interface. That way the actual database is never called.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span> <span class="o">:=</span> <span class="n">GetRouter</span><span class="p">(</span><span class="no">nil</span><span class="p">,</span> <span class="n">getDBClientMock</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api_test.go#L107">source</a></em>)</sup></p>

<p>The rest of the API integration tests is less magical and we just use a <a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api_test.go#L168">helper function</a> to send an http request against an in-memory http server.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">body</span> <span class="o">:=</span> <span class="n">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
<span class="n">gotResponse</span><span class="p">,</span> <span class="n">gotBody</span> <span class="o">:=</span> <span class="n">testRequest</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">wantCode</span><span class="p">,</span> <span class="n">gotResponse</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">)</span>
<span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">wantBody</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
    <span class="n">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">wantBody</span><span class="p">,</span> <span class="n">gotBody</span><span class="p">,</span> <span class="s">"body did not match"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/api_test.go#L157-L162">source</a></em>)</sup></p>

<p>Every test request gets routed to its corresponding API endpoint, which internally calls the functions on the database interface, that we just mocked above.</p>

<h3 id="14-render-responses-with-go-chirender">14. Render Responses With <a href="github.com/go-chi/render">go-chi/render</a></h3>

<p>go-chi comes with a built-in way to render and bind data for your json API. This simplifies our responses to something simple as <code class="language-plaintext highlighter-rouge">render.Render(w, r, article)</code> and <code class="language-plaintext highlighter-rouge">go-chi/render</code> will take care of the rest and that it reaches the client in the right format.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">GetArticle</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">article</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ArticleCtxKey</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">types</span><span class="o">.</span><span class="n">Article</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">render</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">article</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">_</span> <span class="o">=</span> <span class="n">render</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ErrRender</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/operations.go#L22-L29">source</a></em>)</sup></p>

<p>What’s happening behind the scenes here is that the <code class="language-plaintext highlighter-rouge">article</code> object implements the <a href="https://github.com/go-chi/render/blob/master/render.go#L9"><code class="language-plaintext highlighter-rouge">go-chi/render.Renderer</code></a> and <a href="https://github.com/go-chi/render/blob/master/render.go#L14"><code class="language-plaintext highlighter-rouge">go-chi/render.Binder</code></a> interfaces.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Render implements the github.com/go-chi/render.Renderer interface</span>
<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">Article</span><span class="p">)</span> <span class="n">Render</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="c">// Bind implements the the github.com/go-chi/render.Binder interface</span>
<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">Article</span><span class="p">)</span> <span class="n">Bind</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/types/types.go#L20-L28">source</a></em>)</sup></p>

<p>Once these two functions are implemented, you are ready to go and the <code class="language-plaintext highlighter-rouge">article</code> object can be <a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/operations.go#L22-L29">rendered</a> in responses and <a href="https://github.com/jonnylangefeld/go-api/blob/v1.0.0/pkg/api/operations.go#L43-L46">bound</a> in <code class="language-plaintext highlighter-rouge">POST</code> or <code class="language-plaintext highlighter-rouge">PUT</code> requests.</p>

<h3 id="15-documentation-as-code-with-http-swagger">15. Documentation as Code With <a href="https://github.com/swaggo/http-swagger">http-swagger</a></h3>

<p>The <a href="https://swagger.io/specification/">openapi V3</a> specification is the industry standard and a great way to document your API for your users. However, you don’t want to end up writing an independent yaml or json file, that you have to update anytime you change something in your API.<br />
On top of that it would be great if other developers working on the code have the same documentation of a given API function available. <a href="https://github.com/swaggo/http-swagger">http-swagger</a> comes in to fix these problems. The source-of-truth of your API documentation will remain in the docstrings of your handlers, but will be automatically rendered into an openapi spec and displayed via the swagger-ui. Let’s look into how it works.</p>

<p>You might have seen docstrings that look similar to this</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// GetArticle renders the article from the context</span>
<span class="c">// @Summary Get article by id</span>
<span class="c">// @Description GetArticle returns a single article by id</span>
<span class="c">// @Tags Articles</span>
<span class="c">// @Produce json</span>
<span class="c">// @Param id path string true "article id"</span>
<span class="c">// @Router /articles/{id} [get]</span>
<span class="c">// @Success 200 {object} types.Article</span>
<span class="c">// @Failure 400 {object} types.ErrResponse</span>
<span class="c">// @Failure 404 {object} types.ErrResponse</span>
<span class="k">func</span> <span class="n">GetArticle</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/master/pkg/api/operations.go#L12-L22">source</a></em>)</sup></p>

<p>These are a whole bunch of key words, interpreted by <a href="https://github.com/swaggo/swag">swaggo</a>. Check the full documentation <a href="https://github.com/swaggo/swag#declarative-comments-format">here</a>. We are basically collecting all human readable text of the documentation here in the docstring of that handler function and also make links to the possible returned objects. If we change something here, we’ll just have to run <a href="https://github.com/jonnylangefeld/go-api/blob/master/Makefile#L9"><code class="language-plaintext highlighter-rouge">make generate-docs</code></a>, and we’ll get all files in the <a href="https://github.com/jonnylangefeld/go-api/tree/master/docs"><code class="language-plaintext highlighter-rouge">docs</code></a> directory, which includes an openapi json, yaml and some go code, automatically generated. If we want to inject something into the spec, like the current build version, we can do so from the <code class="language-plaintext highlighter-rouge">main</code> file:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docs</span><span class="o">.</span><span class="n">SwaggerInfo</span><span class="o">.</span><span class="n">Version</span> <span class="o">=</span> <span class="n">version</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/master/main.go#L28">source</a></em>)</sup></p>

<p>All that’s left to do now is expose the swagger UI via an endpoint:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/swagger"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">http</span><span class="o">.</span><span class="n">Redirect</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">RequestURI</span><span class="o">+</span><span class="s">"/"</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusMovedPermanently</span><span class="p">)</span>
<span class="p">})</span>
<span class="n">r</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"/swagger*"</span><span class="p">,</span> <span class="n">httpSwagger</span><span class="o">.</span><span class="n">Handler</span><span class="p">())</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/master/pkg/api/api.go#L44-L47">source</a></em>)</sup></p>

<p>Now once that’s all set up, we can access the swagger UI via <a href="http://localhost:8080/swagger">http://localhost:8080/swagger</a>, and we get the fully featured swagger UI for our API:</p>

<p><img src="/assets/posts/swagger-ui.png" width="100%" align="middle" style="margin: 15px" /></p>

<p>It comes with all the models and even examples that you can add via struct tags like the following:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Article is one instance of an article</span>
<span class="k">type</span> <span class="n">Article</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// The unique id of this item</span>
	<span class="n">ID</span> <span class="kt">int</span> <span class="s">`gorm:"type:SERIAL;PRIMARY_KEY" json:"id" example:"1"`</span>
	<span class="c">// The name of this item</span>
	<span class="n">Name</span> <span class="kt">string</span> <span class="s">`gorm:"type:varchar;NOT NULL" json:"name" example:"Skittles"`</span>
	<span class="c">// The price of this item</span>
	<span class="n">Price</span> <span class="kt">float64</span> <span class="s">`gorm:"type:decimal;NOT NULL" json:"price" example:"1.99"`</span>
<span class="p">}</span> <span class="c">// @name Article</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/master/pkg/types/types.go#L10-L18">source</a></em>)</sup></p>

<p><img src="/assets/posts/swagger-details.png" width="100%" align="middle" style="margin: 15px" /></p>

<h3 id="16-staged-dockerfile">16. Staged Dockerfile</h3>

<p>Last but not least, I always recommend to have a staged <code class="language-plaintext highlighter-rouge">Dockerfile</code> to allow us to use a <a href="https://github.com/GoogleContainerTools/distroless">distroless</a> executable-stage image. That means your build stage is separated from the actual executable stage and will make your posted image way smaller.</p>

<blockquote>
  <p>Restricting what’s in your runtime container to precisely what’s necessary for your app is a best practice employed by Google and other tech giants that have used containers in production for many years. It improves the signal to noise of scanners (e.g. CVE) and reduces the burden of establishing provenance to just what you need.</p>
</blockquote>

<p><sup>(<em><a href="https://github.com/GoogleContainerTools/distroless#why-should-i-use-distroless-images">source</a></em>)</sup></p>

<p>That means that we build our binary through a docker container via the following:</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> golang:1.14 as gobuild</span>
<span class="k">ARG</span><span class="s"> VERSION=latest</span>

<span class="k">WORKDIR</span><span class="s"> /go/src/github.com/jonnylangefeld/go-api</span>
<span class="k">ADD</span><span class="s"> go.mod go.sum main.go ./</span>
<span class="k">ADD</span><span class="s"> vendor ./vendor</span>
<span class="k">ADD</span><span class="s"> pkg ./pkg</span>
<span class="k">ADD</span><span class="s"> docs ./docs</span>

<span class="k">RUN </span><span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GO111MODULE</span><span class="o">=</span>on go build <span class="nt">-mod</span><span class="o">=</span>vendor <span class="nt">-o</span> go-api <span class="nt">-ldflags</span> <span class="s2">"-X main.version=</span><span class="nv">$VERSION</span><span class="s2">"</span> main.go
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/master/Dockerfile#L1-L10">source</a></em>)</sup></p>

<p>And then we just copy that binary over to a distroless docker image:</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> gcr.io/distroless/base</span>

<span class="k">COPY</span><span class="s"> --from=gobuild /go/src/github.com/jonnylangefeld/go-api/go-api /bin</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["/bin/go-api"]</span>
</code></pre></div></div>
<p><sup>(<em><a href="https://github.com/jonnylangefeld/go-api/blob/master/Dockerfile#L12-L16">source</a></em>)</sup></p>

  </div>

  <p class="extra-info">
    
      Tags: go, golang, api, programming, software development, repo, ultimate guide, dockertest, chi, swagger, structured logging, best practices, how to
    
  </p>
</article>

      </div>
    </main>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          <li>
            <a href="https://github.com/jonnylangefeld" target="_blank"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

          </li>
          <li>
            <a href="https://twitter.com/jonnylangefeld" target="_blank"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

          </li>
          <li>
            <a href="https://www.linkedin.com/in/jonnylangefeld"><span class="icon icon--linked"><svg width="16px" height="16px" viewBox="0 0 430.117 430.117" xml:space="preserve"><path id="LinkedIn" fill="#828282" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707 c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21 v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824 C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463 c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z M5.477,420.56h92.184v-277.32H5.477V420.56z"/></svg>
</span><span class="username">jonnylangefeld</span></a>

          </li>
          <li>
            <a href="https://instagram.com/jonnylangefeld" target="_blank"><span class="icon icon--instagram"><svg aria-hidden="true" data-prefix="fab" data-icon="instagram" class="svg-inline--fa fa-instagram fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16px" style="padding-right: 4px;"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span><span class="username">jonnylangefeld</span></a>

          </li>
        </ul>
      </div>
      <div class="footer-col footer-col-2"></div>

      <div class="footer-col footer-col-3" style="text-align: right">
        <p>email: <a href="mailto:jonny.langefeld@gmail.com">jonny.langefeld@gmail.com</a><br />
          twitter: <a href="https://twitter.com/jonnylangefeld" target="_blank">@jonnylangefeld</a></p>
      </div>
    </div>

  </div>
</footer>

<script type="text/javascript">
  var links = document.links;
  for (var i = 0, linksLength = links.length; i < linksLength; i++) {
    if (links[i].hostname != window.location.hostname) {
      links[i].target = '_blank';
    } 
  }
</script>


  </body>

</html>
